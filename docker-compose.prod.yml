# =============================================================================
# Relay - Production Docker Compose
# For local production testing and staging environments
# =============================================================================
# Usage:
#   docker-compose -f docker-compose.prod.yml up --build
#
# Environment variables:
#   Create a .env.production file with required secrets
# =============================================================================

version: "3.8"

services:
  # ---------------------------------------------------------------------------
  # API Service
  # ---------------------------------------------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: relay-api
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgresql://${POSTGRES_USER:-relay}:${POSTGRES_PASSWORD:-relay}@postgres:5432/${POSTGRES_DB:-relay}?schema=public
      REDIS_URL: redis://redis:6379
      LOG_LEVEL: ${LOG_LEVEL:-info}
      # Secrets - these should be set in .env.production
      API_KEY_SECRET: ${API_KEY_SECRET}
      WEBHOOK_SIGNING_SECRET: ${WEBHOOK_SIGNING_SECRET}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      CORS_ORIGIN: ${CORS_ORIGIN:-*}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/api/health/ready",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - relay-network
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M

  # ---------------------------------------------------------------------------
  # Database Migration (run once)
  # ---------------------------------------------------------------------------
  migrate:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: relay-migrate
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-relay}:${POSTGRES_PASSWORD:-relay}@postgres:5432/${POSTGRES_DB:-relay}?schema=public
    command: yarn db:migrate:deploy
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - relay-network
    restart: "no"

  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: relay-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-relay}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-relay}
      POSTGRES_DB: ${POSTGRES_DB:-relay}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER:-relay} -d ${POSTGRES_DB:-relay}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - relay-network
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  # ---------------------------------------------------------------------------
  # Redis Cache
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: relay-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 100mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - relay-network
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 128M

  # ---------------------------------------------------------------------------
  # Admin UI (static build served by nginx)
  # ---------------------------------------------------------------------------
  admin-ui:
    build:
      context: .
      dockerfile: Dockerfile.admin-ui
    container_name: relay-admin-ui
    restart: unless-stopped
    ports:
      - "${ADMIN_UI_PORT:-3001}:80"
    environment:
      API_URL: ${API_URL:-http://localhost:3000}
    depends_on:
      - api
    networks:
      - relay-network
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 64M

networks:
  relay-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
