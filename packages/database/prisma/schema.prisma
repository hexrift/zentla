generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// WORKSPACE & TENANCY
// ============================================================================

model Workspace {
  id              String   @id @default(uuid()) @db.Uuid
  name            String   @db.VarChar(100)
  slug            String   @unique @db.VarChar(100)
  defaultProvider Provider @default(stripe) @map("default_provider")
  settings        Json     @default("{}")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  customers        Customer[]
  offers           Offer[]
  subscriptions    Subscription[]
  entitlements     Entitlement[]
  checkouts        Checkout[]
  webhookEndpoints WebhookEndpoint[]
  webhookEvents    WebhookEvent[]
  apiKeys          ApiKey[]
  auditLogs        AuditLog[]
  providerRefs     ProviderRef[]
  outboxEvents     OutboxEvent[]
  deadLetterEvents DeadLetterEvent[]

  @@map("workspace")
}

enum Provider {
  stripe
  zuora

  @@map("provider")
}

// ============================================================================
// CUSTOMERS
// ============================================================================

model Customer {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  externalId  String?  @map("external_id") @db.VarChar(255)
  email       String   @db.VarChar(255)
  name        String?  @db.VarChar(200)
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace     Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]
  entitlements  Entitlement[]
  checkouts     Checkout[]

  @@unique([workspaceId, email])
  @@unique([workspaceId, externalId])
  @@index([workspaceId])
  @@index([email])
  @@map("customer")
}

// ============================================================================
// OFFERS & VERSIONING
// ============================================================================

model Offer {
  id               String      @id @default(uuid()) @db.Uuid
  workspaceId      String      @map("workspace_id") @db.Uuid
  name             String      @db.VarChar(200)
  description      String?     @db.VarChar(1000)
  status           OfferStatus @default(active)
  currentVersionId String?     @map("current_version_id") @db.Uuid
  createdAt        DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime    @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace      Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  versions       OfferVersion[]
  currentVersion OfferVersion?   @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  subscriptions  Subscription[]
  checkouts      Checkout[]

  @@index([workspaceId])
  @@index([workspaceId, status])
  @@map("offer")
}

enum OfferStatus {
  active
  archived

  @@map("offer_status")
}

model OfferVersion {
  id          String             @id @default(uuid()) @db.Uuid
  offerId     String             @map("offer_id") @db.Uuid
  version     Int
  status      OfferVersionStatus @default(draft)
  config      Json
  publishedAt DateTime?          @map("published_at") @db.Timestamptz
  createdAt   DateTime           @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  offer              Offer          @relation(fields: [offerId], references: [id], onDelete: Cascade)
  currentForOffers   Offer[]        @relation("CurrentVersion")
  subscriptions      Subscription[]
  checkouts          Checkout[]

  @@unique([offerId, version])
  @@index([offerId])
  @@index([offerId, status])
  @@map("offer_version")
}

enum OfferVersionStatus {
  draft
  published
  archived

  @@map("offer_version_status")
}

// ============================================================================
// SUBSCRIPTIONS
// ============================================================================

model Subscription {
  id                 String             @id @default(uuid()) @db.Uuid
  workspaceId        String             @map("workspace_id") @db.Uuid
  customerId         String             @map("customer_id") @db.Uuid
  offerId            String             @map("offer_id") @db.Uuid
  offerVersionId     String             @map("offer_version_id") @db.Uuid
  status             SubscriptionStatus @default(incomplete)
  currentPeriodStart DateTime           @map("current_period_start") @db.Timestamptz
  currentPeriodEnd   DateTime           @map("current_period_end") @db.Timestamptz
  cancelAt           DateTime?          @map("cancel_at") @db.Timestamptz
  canceledAt         DateTime?          @map("canceled_at") @db.Timestamptz
  endedAt            DateTime?          @map("ended_at") @db.Timestamptz
  trialStart         DateTime?          @map("trial_start") @db.Timestamptz
  trialEnd           DateTime?          @map("trial_end") @db.Timestamptz
  metadata           Json               @default("{}")
  createdAt          DateTime           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime           @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace    Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  customer     Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  offer        Offer          @relation(fields: [offerId], references: [id])
  offerVersion OfferVersion   @relation(fields: [offerVersionId], references: [id])
  entitlements Entitlement[]

  @@index([workspaceId])
  @@index([customerId])
  @@index([workspaceId, status])
  @@index([workspaceId, customerId])
  @@map("subscription")
}

enum SubscriptionStatus {
  trialing
  active
  past_due
  canceled
  unpaid
  incomplete
  incomplete_expired
  paused

  @@map("subscription_status")
}

// ============================================================================
// ENTITLEMENTS
// ============================================================================

model Entitlement {
  id             String               @id @default(uuid()) @db.Uuid
  workspaceId    String               @map("workspace_id") @db.Uuid
  customerId     String               @map("customer_id") @db.Uuid
  subscriptionId String               @map("subscription_id") @db.Uuid
  featureKey     String               @map("feature_key") @db.VarChar(100)
  value          String               @db.VarChar(255)
  valueType      EntitlementValueType @map("value_type")
  expiresAt      DateTime?            @map("expires_at") @db.Timestamptz
  createdAt      DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime             @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace    Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  customer     Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, featureKey])
  @@index([workspaceId])
  @@index([customerId])
  @@index([workspaceId, customerId, featureKey])
  @@map("entitlement")
}

enum EntitlementValueType {
  boolean
  number
  string
  unlimited

  @@map("entitlement_value_type")
}

// ============================================================================
// CHECKOUT
// ============================================================================

model Checkout {
  id             String         @id @default(uuid()) @db.Uuid
  workspaceId    String         @map("workspace_id") @db.Uuid
  customerId     String?        @map("customer_id") @db.Uuid
  offerId        String         @map("offer_id") @db.Uuid
  offerVersionId String         @map("offer_version_id") @db.Uuid
  status         CheckoutStatus @default(pending)
  sessionUrl     String?        @map("session_url") @db.VarChar(2048)
  successUrl     String         @map("success_url") @db.VarChar(2048)
  cancelUrl      String         @map("cancel_url") @db.VarChar(2048)
  customerEmail  String?        @map("customer_email") @db.VarChar(255)
  expiresAt      DateTime       @map("expires_at") @db.Timestamptz
  completedAt    DateTime?      @map("completed_at") @db.Timestamptz
  metadata       Json           @default("{}")
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime       @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  customer     Customer?     @relation(fields: [customerId], references: [id])
  offer        Offer         @relation(fields: [offerId], references: [id])
  offerVersion OfferVersion  @relation(fields: [offerVersionId], references: [id])

  @@index([workspaceId])
  @@index([workspaceId, status])
  @@map("checkout")
}

enum CheckoutStatus {
  pending
  open
  complete
  expired

  @@map("checkout_status")
}

// ============================================================================
// WEBHOOKS
// ============================================================================

model WebhookEndpoint {
  id          String                @id @default(uuid()) @db.Uuid
  workspaceId String                @map("workspace_id") @db.Uuid
  url         String                @db.VarChar(2048)
  secret      String                @db.VarChar(255)
  events      String[]
  status      WebhookEndpointStatus @default(active)
  description String?               @db.VarChar(500)
  metadata    Json                  @default("{}")
  createdAt   DateTime              @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime              @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace       Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  webhookEvents   WebhookEvent[]
  deadLetterEvents DeadLetterEvent[]

  @@index([workspaceId])
  @@index([workspaceId, status])
  @@map("webhook_endpoint")
}

enum WebhookEndpointStatus {
  active
  disabled

  @@map("webhook_endpoint_status")
}

model WebhookEvent {
  id            String             @id @default(uuid()) @db.Uuid
  workspaceId   String             @map("workspace_id") @db.Uuid
  endpointId    String             @map("endpoint_id") @db.Uuid
  eventType     String             @map("event_type") @db.VarChar(100)
  payload       Json
  status        WebhookEventStatus @default(pending)
  attempts      Int                @default(0)
  lastAttemptAt DateTime?          @map("last_attempt_at") @db.Timestamptz
  nextRetryAt   DateTime?          @map("next_retry_at") @db.Timestamptz
  deliveredAt   DateTime?          @map("delivered_at") @db.Timestamptz
  response      Json?
  createdAt     DateTime           @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  workspace Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  endpoint  WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([endpointId])
  @@index([status, nextRetryAt])
  @@map("webhook_event")
}

enum WebhookEventStatus {
  pending
  delivered
  failed
  dead_letter

  @@map("webhook_event_status")
}

// ============================================================================
// API KEYS
// ============================================================================

model ApiKey {
  id          String            @id @default(uuid()) @db.Uuid
  workspaceId String            @map("workspace_id") @db.Uuid
  name        String            @db.VarChar(100)
  keyPrefix   String            @map("key_prefix") @db.VarChar(20)
  keyHash     String            @map("key_hash") @db.VarChar(255)
  role        ApiKeyRole        @default(member)
  environment ApiKeyEnvironment @default(test)
  lastUsedAt  DateTime?         @map("last_used_at") @db.Timestamptz
  expiresAt   DateTime?         @map("expires_at") @db.Timestamptz
  revokedAt   DateTime?         @map("revoked_at") @db.Timestamptz
  createdAt   DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([keyPrefix])
  @@index([workspaceId])
  @@index([keyHash])
  @@map("api_key")
}

enum ApiKeyRole {
  owner
  admin
  member
  readonly

  @@map("api_key_role")
}

enum ApiKeyEnvironment {
  live
  test

  @@map("api_key_environment")
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id           String    @id @default(uuid()) @db.Uuid
  workspaceId  String    @map("workspace_id") @db.Uuid
  actorType    ActorType @map("actor_type")
  actorId      String    @map("actor_id") @db.VarChar(255)
  action       String    @db.VarChar(50)
  resourceType String    @map("resource_type") @db.VarChar(50)
  resourceId   String    @map("resource_id") @db.VarChar(255)
  changes      Json?
  metadata     Json      @default("{}")
  ipAddress    String?   @map("ip_address") @db.VarChar(45)
  userAgent    String?   @map("user_agent") @db.VarChar(500)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([workspaceId, resourceType, resourceId])
  @@index([workspaceId, createdAt])
  @@map("audit_log")
}

enum ActorType {
  api_key
  user
  system
  webhook

  @@map("actor_type")
}

// ============================================================================
// PROVIDER REFERENCE MAPPING
// ============================================================================

model ProviderRef {
  id         String     @id @default(uuid()) @db.Uuid
  workspaceId String    @map("workspace_id") @db.Uuid
  entityType EntityType @map("entity_type")
  entityId   String     @map("entity_id") @db.Uuid
  provider   Provider
  externalId String     @map("external_id") @db.VarChar(255)
  metadata   Json?
  createdAt  DateTime   @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, provider, entityType, externalId])
  @@unique([workspaceId, entityType, entityId, provider])
  @@index([workspaceId])
  @@index([entityType, entityId])
  @@map("provider_ref")
}

enum EntityType {
  customer
  offer
  offer_version
  subscription
  checkout
  product
  price

  @@map("entity_type")
}

// ============================================================================
// OUTBOX PATTERN FOR RELIABLE EVENT DELIVERY
// ============================================================================

model OutboxEvent {
  id            String            @id @default(uuid()) @db.Uuid
  workspaceId   String            @map("workspace_id") @db.Uuid
  eventType     String            @map("event_type") @db.VarChar(100)
  aggregateType String            @map("aggregate_type") @db.VarChar(50)
  aggregateId   String            @map("aggregate_id") @db.Uuid
  payload       Json
  status        OutboxEventStatus @default(pending)
  processedAt   DateTime?         @map("processed_at") @db.Timestamptz
  createdAt     DateTime          @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([status, createdAt])
  @@index([workspaceId])
  @@map("outbox_event")
}

enum OutboxEventStatus {
  pending
  processed
  failed

  @@map("outbox_event_status")
}

model DeadLetterEvent {
  id              String   @id @default(uuid()) @db.Uuid
  workspaceId     String   @map("workspace_id") @db.Uuid
  originalEventId String   @map("original_event_id") @db.Uuid
  endpointId      String   @map("endpoint_id") @db.Uuid
  eventType       String   @map("event_type") @db.VarChar(100)
  payload         Json
  failureReason   String   @map("failure_reason") @db.VarChar(1000)
  attempts        Int
  lastAttemptAt   DateTime @map("last_attempt_at") @db.Timestamptz
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  workspace Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  endpoint  WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([endpointId])
  @@map("dead_letter_event")
}

// ============================================================================
// IDEMPOTENCY
// ============================================================================

model IdempotencyKey {
  id            String   @id @default(uuid()) @db.Uuid
  key           String   @unique @db.VarChar(512)
  workspaceId   String   @map("workspace_id") @db.Uuid
  requestPath   String   @map("request_path") @db.VarChar(2048)
  requestMethod String   @map("request_method") @db.VarChar(10)
  response      Json?
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  expiresAt     DateTime @map("expires_at") @db.Timestamptz

  @@index([key])
  @@index([expiresAt])
  @@map("idempotency_key")
}

// ============================================================================
// PROCESSED STRIPE EVENTS (for webhook deduplication)
// ============================================================================

model ProcessedStripeEvent {
  id          String   @id @default(uuid()) @db.Uuid
  stripeEventId String @unique @map("stripe_event_id") @db.VarChar(255)
  eventType   String   @map("event_type") @db.VarChar(100)
  processedAt DateTime @default(now()) @map("processed_at") @db.Timestamptz

  @@index([stripeEventId])
  @@index([processedAt])
  @@map("processed_stripe_event")
}
