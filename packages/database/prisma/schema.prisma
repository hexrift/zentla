generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USERS & AUTHENTICATION
// ============================================================================

model User {
  id              String    @id @default(uuid()) @db.Uuid
  email           String    @unique @db.VarChar(255)
  name            String?   @db.VarChar(200)
  avatarUrl       String?   @map("avatar_url") @db.VarChar(2048)
  passwordHash    String?   @map("password_hash") @db.VarChar(255)

  // OAuth providers
  githubId        String?   @unique @map("github_id") @db.VarChar(255)
  googleId        String?   @unique @map("google_id") @db.VarChar(255)

  // Email verification
  emailVerifiedAt DateTime? @map("email_verified_at") @db.Timestamptz

  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  memberships     WorkspaceMembership[]
  sessions        UserSession[]

  @@index([email])
  @@map("user")
}

model UserSession {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  userAgent String?  @map("user_agent") @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
  @@map("user_session")
}

// ============================================================================
// WORKSPACE & TENANCY
// ============================================================================

model Workspace {
  id              String        @id @default(uuid()) @db.Uuid
  name            String        @db.VarChar(100)
  slug            String        @unique @db.VarChar(100)
  defaultProvider Provider      @default(stripe) @map("default_provider")
  settings        Json          @default("{}")

  // Environment mode - default to test for safety
  mode            WorkspaceMode @default(test)

  // Live mode access control
  liveAccessRequestedAt DateTime? @map("live_access_requested_at") @db.Timestamptz
  liveAccessGrantedAt   DateTime? @map("live_access_granted_at") @db.Timestamptz
  liveAccessDeniedAt    DateTime? @map("live_access_denied_at") @db.Timestamptz

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  memberships       WorkspaceMembership[]
  customers         Customer[]
  offers            Offer[]
  promotions        Promotion[]
  subscriptions     Subscription[]
  entitlements      Entitlement[]
  checkouts         Checkout[]
  checkoutIntents   CheckoutIntent[]
  appliedPromotions AppliedPromotion[]
  webhookEndpoints  WebhookEndpoint[]
  webhookEvents     WebhookEvent[]
  apiKeys           ApiKey[]
  auditLogs         AuditLog[]
  providerRefs      ProviderRef[]
  outboxEvents      OutboxEvent[]
  deadLetterEvents  DeadLetterEvent[]
  seatAssignments   SeatAssignment[]
  experiments       Experiment[]

  @@map("workspace")
}

enum WorkspaceMode {
  test
  live

  @@map("workspace_mode")
}

model WorkspaceMembership {
  id          String        @id @default(uuid()) @db.Uuid
  workspaceId String        @map("workspace_id") @db.Uuid
  userId      String        @map("user_id") @db.Uuid
  role        WorkspaceRole @default(admin)
  createdAt   DateTime      @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime      @updatedAt @map("updated_at") @db.Timestamptz

  workspace   Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId])
  @@index([workspaceId])
  @@map("workspace_membership")
}

enum WorkspaceRole {
  owner
  admin

  @@map("workspace_role")
}

enum Provider {
  stripe
  zuora

  @@map("provider")
}

// ============================================================================
// CUSTOMERS
// ============================================================================

model Customer {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  externalId  String?  @map("external_id") @db.VarChar(255)
  email       String   @db.VarChar(255)
  name        String?  @db.VarChar(200)
  metadata    Json     @default("{}")
  version     Int      @default(1)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace         Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  subscriptions     Subscription[]
  entitlements      Entitlement[]
  checkouts         Checkout[]
  checkoutIntents   CheckoutIntent[]
  appliedPromotions AppliedPromotion[]
  seatAssignments   SeatAssignment[]

  @@unique([workspaceId, email])
  @@unique([workspaceId, externalId])
  @@index([workspaceId])
  @@index([email])
  @@map("customer")
}

// ============================================================================
// OFFERS & VERSIONING
// ============================================================================

model Offer {
  id               String      @id @default(uuid()) @db.Uuid
  workspaceId      String      @map("workspace_id") @db.Uuid
  name             String      @db.VarChar(200)
  description      String?     @db.VarChar(1000)
  status           OfferStatus @default(active)
  currentVersionId String?     @map("current_version_id") @db.Uuid
  metadata         Json        @default("{}") // Campaign/context metadata (e.g., campaign, channel, source)
  version          Int         @default(1)
  createdAt        DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime    @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace       Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  versions        OfferVersion[]
  currentVersion  OfferVersion?    @relation("CurrentVersion", fields: [currentVersionId], references: [id])
  subscriptions   Subscription[]
  checkouts       Checkout[]
  checkoutIntents CheckoutIntent[]

  @@index([workspaceId])
  @@index([workspaceId, status])
  @@map("offer")
}

enum OfferStatus {
  draft
  active
  archived

  @@map("offer_status")
}

model OfferVersion {
  id            String             @id @default(uuid()) @db.Uuid
  offerId       String             @map("offer_id") @db.Uuid
  version       Int
  status        OfferVersionStatus @default(draft)
  config        Json
  publishedAt   DateTime?          @map("published_at") @db.Timestamptz
  effectiveFrom DateTime?          @map("effective_from") @db.Timestamptz
  createdAt     DateTime           @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  offer              Offer            @relation(fields: [offerId], references: [id], onDelete: Cascade)
  currentForOffers   Offer[]          @relation("CurrentVersion")
  subscriptions      Subscription[]
  checkouts          Checkout[]
  checkoutIntents    CheckoutIntent[]

  @@unique([offerId, version])
  @@index([offerId])
  @@index([offerId, status])
  @@index([offerId, status, effectiveFrom])
  @@map("offer_version")
}

enum OfferVersionStatus {
  draft
  published
  archived

  @@map("offer_version_status")
}

// ============================================================================
// PROMOTIONS & VERSIONING
// ============================================================================

model Promotion {
  id               String          @id @default(uuid()) @db.Uuid
  workspaceId      String          @map("workspace_id") @db.Uuid
  code             String          @db.VarChar(50)
  name             String          @db.VarChar(100)
  description      String?         @db.VarChar(1000)
  status           PromotionStatus @default(draft)
  currentVersionId String?         @unique @map("current_version_id") @db.Uuid
  createdAt        DateTime        @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime        @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace         Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  versions          PromotionVersion[]
  currentVersion    PromotionVersion?  @relation("CurrentPromotionVersion", fields: [currentVersionId], references: [id])
  appliedPromotions AppliedPromotion[]
  checkoutIntents   CheckoutIntent[]

  @@unique([workspaceId, code])
  @@index([workspaceId])
  @@index([workspaceId, status])
  @@map("promotion")
}

enum PromotionStatus {
  draft
  active
  archived

  @@map("promotion_status")
}

model PromotionVersion {
  id          String                 @id @default(uuid()) @db.Uuid
  promotionId String                 @map("promotion_id") @db.Uuid
  version     Int
  status      PromotionVersionStatus @default(draft)
  config      Json
  publishedAt DateTime?              @map("published_at") @db.Timestamptz
  createdAt   DateTime               @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  promotion           Promotion          @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  currentForPromotion Promotion?         @relation("CurrentPromotionVersion")
  appliedPromotions   AppliedPromotion[]
  checkoutIntents     CheckoutIntent[]

  @@unique([promotionId, version])
  @@index([promotionId])
  @@index([promotionId, status])
  @@map("promotion_version")
}

enum PromotionVersionStatus {
  draft
  published
  archived

  @@map("promotion_version_status")
}

model AppliedPromotion {
  id                 String   @id @default(uuid()) @db.Uuid
  workspaceId        String   @map("workspace_id") @db.Uuid
  promotionId        String   @map("promotion_id") @db.Uuid
  promotionVersionId String   @map("promotion_version_id") @db.Uuid
  checkoutId         String?  @map("checkout_id") @db.Uuid
  subscriptionId     String?  @map("subscription_id") @db.Uuid
  customerId         String   @map("customer_id") @db.Uuid
  discountAmount     Int      @map("discount_amount")
  appliedAt          DateTime @default(now()) @map("applied_at") @db.Timestamptz

  // Relations
  workspace        Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  promotion        Promotion        @relation(fields: [promotionId], references: [id])
  promotionVersion PromotionVersion @relation(fields: [promotionVersionId], references: [id])
  checkout         Checkout?        @relation(fields: [checkoutId], references: [id])
  subscription     Subscription?    @relation(fields: [subscriptionId], references: [id])
  customer         Customer         @relation(fields: [customerId], references: [id])

  @@index([workspaceId])
  @@index([promotionId])
  @@index([customerId])
  @@index([checkoutId])
  @@index([subscriptionId])
  @@map("applied_promotion")
}

// ============================================================================
// SUBSCRIPTIONS
// ============================================================================

model Subscription {
  id                 String             @id @default(uuid()) @db.Uuid
  workspaceId        String             @map("workspace_id") @db.Uuid
  customerId         String             @map("customer_id") @db.Uuid
  offerId            String             @map("offer_id") @db.Uuid
  offerVersionId     String             @map("offer_version_id") @db.Uuid
  status             SubscriptionStatus @default(pending)
  currentPeriodStart DateTime           @map("current_period_start") @db.Timestamptz
  currentPeriodEnd   DateTime           @map("current_period_end") @db.Timestamptz
  cancelAt           DateTime?          @map("cancel_at") @db.Timestamptz
  canceledAt         DateTime?          @map("canceled_at") @db.Timestamptz
  endedAt            DateTime?          @map("ended_at") @db.Timestamptz
  trialStart         DateTime?          @map("trial_start") @db.Timestamptz
  trialEnd           DateTime?          @map("trial_end") @db.Timestamptz
  metadata           Json               @default("{}")
  version            Int                @default(1)
  createdAt          DateTime           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt          DateTime           @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace         Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  customer          Customer           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  offer             Offer              @relation(fields: [offerId], references: [id])
  offerVersion      OfferVersion       @relation(fields: [offerVersionId], references: [id])
  entitlements      Entitlement[]
  appliedPromotions AppliedPromotion[]
  checkoutIntents   CheckoutIntent[]

  @@index([workspaceId])
  @@index([customerId])
  @@index([workspaceId, status])
  @@index([workspaceId, customerId])
  @@map("subscription")
}

enum SubscriptionStatus {
  trialing
  active
  payment_failed
  canceled
  suspended
  pending
  expired
  paused

  @@map("subscription_status")
}

// ============================================================================
// ENTITLEMENTS
// ============================================================================

model Entitlement {
  id             String               @id @default(uuid()) @db.Uuid
  workspaceId    String               @map("workspace_id") @db.Uuid
  customerId     String               @map("customer_id") @db.Uuid
  subscriptionId String               @map("subscription_id") @db.Uuid
  featureKey     String               @map("feature_key") @db.VarChar(100)
  value          String               @db.VarChar(255)
  valueType      EntitlementValueType @map("value_type")
  expiresAt      DateTime?            @map("expires_at") @db.Timestamptz
  createdAt      DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime             @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace    Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  customer     Customer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, featureKey])
  @@index([workspaceId])
  @@index([customerId])
  @@index([workspaceId, customerId, featureKey])
  @@map("entitlement")
}

enum EntitlementValueType {
  boolean
  number
  string
  unlimited

  @@map("entitlement_value_type")
}

// ============================================================================
// CHECKOUT
// ============================================================================

model Checkout {
  id             String         @id @default(uuid()) @db.Uuid
  workspaceId    String         @map("workspace_id") @db.Uuid
  customerId     String?        @map("customer_id") @db.Uuid
  offerId        String         @map("offer_id") @db.Uuid
  offerVersionId String         @map("offer_version_id") @db.Uuid
  status         CheckoutStatus @default(pending)
  sessionUrl     String?        @map("session_url") @db.VarChar(2048)
  successUrl     String         @map("success_url") @db.VarChar(2048)
  cancelUrl      String         @map("cancel_url") @db.VarChar(2048)
  customerEmail  String?        @map("customer_email") @db.VarChar(255)
  expiresAt      DateTime       @map("expires_at") @db.Timestamptz
  completedAt    DateTime?      @map("completed_at") @db.Timestamptz
  metadata       Json           @default("{}")
  createdAt      DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime       @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace         Workspace          @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  customer          Customer?          @relation(fields: [customerId], references: [id])
  offer             Offer              @relation(fields: [offerId], references: [id])
  offerVersion      OfferVersion       @relation(fields: [offerVersionId], references: [id])
  appliedPromotions AppliedPromotion[]

  @@index([workspaceId])
  @@index([workspaceId, status])
  @@map("checkout")
}

enum CheckoutStatus {
  pending
  open
  complete
  expired

  @@map("checkout_status")
}

// Headless checkout flow - for custom checkout UIs
model CheckoutIntent {
  id                   String               @id @default(uuid()) @db.Uuid
  workspaceId          String               @map("workspace_id") @db.Uuid
  customerId           String?              @map("customer_id") @db.Uuid
  offerId              String               @map("offer_id") @db.Uuid
  offerVersionId       String               @map("offer_version_id") @db.Uuid
  status               CheckoutIntentStatus @default(pending)

  // Quote snapshot - locked at creation
  currency             String               @db.VarChar(3)
  subtotalAmount       Int                  @map("subtotal_amount")
  discountAmount       Int                  @default(0) @map("discount_amount")
  taxAmount            Int                  @default(0) @map("tax_amount")
  totalAmount          Int                  @map("total_amount")

  // Trial info
  trialDays            Int?                 @map("trial_days")

  // Promotion applied
  promotionId          String?              @map("promotion_id") @db.Uuid
  promotionVersionId   String?              @map("promotion_version_id") @db.Uuid
  promotionCode        String?              @map("promotion_code") @db.VarChar(50)

  // Provider payment reference (PaymentIntent/SetupIntent ID)
  providerPaymentId    String?              @map("provider_payment_id") @db.VarChar(255)
  clientSecret         String?              @map("client_secret") @db.VarChar(500)

  // Idempotency
  idempotencyKey       String?              @unique @map("idempotency_key") @db.VarChar(255)

  // Result
  subscriptionId       String?              @map("subscription_id") @db.Uuid
  customerEmail        String?              @map("customer_email") @db.VarChar(255)
  metadata             Json                 @default("{}")

  expiresAt            DateTime             @map("expires_at") @db.Timestamptz
  completedAt          DateTime?            @map("completed_at") @db.Timestamptz
  createdAt            DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime             @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace            Workspace            @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  customer             Customer?            @relation(fields: [customerId], references: [id])
  offer                Offer                @relation(fields: [offerId], references: [id])
  offerVersion         OfferVersion         @relation(fields: [offerVersionId], references: [id])
  subscription         Subscription?        @relation(fields: [subscriptionId], references: [id])
  promotion            Promotion?           @relation(fields: [promotionId], references: [id])
  promotionVersion     PromotionVersion?    @relation(fields: [promotionVersionId], references: [id])

  @@index([workspaceId])
  @@index([workspaceId, status])
  @@index([idempotencyKey])
  @@map("checkout_intent")
}

enum CheckoutIntentStatus {
  pending              // Created, awaiting payment
  processing           // Payment in progress
  requires_action      // Needs 3DS or other action
  succeeded            // Payment complete, subscription created
  failed               // Payment failed
  expired              // Timed out

  @@map("checkout_intent_status")
}

// ============================================================================
// WEBHOOKS
// ============================================================================

model WebhookEndpoint {
  id          String                @id @default(uuid()) @db.Uuid
  workspaceId String                @map("workspace_id") @db.Uuid
  url         String                @db.VarChar(2048)
  secret      String                @db.VarChar(255)
  events      String[]
  status      WebhookEndpointStatus @default(active)
  description String?               @db.VarChar(500)
  metadata    Json                  @default("{}")
  version     Int                   @default(1)

  // Delivery visibility
  lastDeliveryAt    DateTime?       @map("last_delivery_at") @db.Timestamptz
  lastDeliveryStatus Int?           @map("last_delivery_status")  // HTTP status code
  lastErrorAt       DateTime?       @map("last_error_at") @db.Timestamptz
  lastError         String?         @map("last_error") @db.VarChar(1000)
  successCount      Int             @default(0) @map("success_count")
  failureCount      Int             @default(0) @map("failure_count")

  createdAt   DateTime              @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime              @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace       Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  webhookEvents   WebhookEvent[]
  deadLetterEvents DeadLetterEvent[]

  @@index([workspaceId])
  @@index([workspaceId, status])
  @@map("webhook_endpoint")
}

enum WebhookEndpointStatus {
  active
  disabled

  @@map("webhook_endpoint_status")
}

model WebhookEvent {
  id            String             @id @default(uuid()) @db.Uuid
  workspaceId   String             @map("workspace_id") @db.Uuid
  endpointId    String             @map("endpoint_id") @db.Uuid
  eventType     String             @map("event_type") @db.VarChar(100)
  payload       Json
  status        WebhookEventStatus @default(pending)
  attempts      Int                @default(0)
  lastAttemptAt DateTime?          @map("last_attempt_at") @db.Timestamptz
  nextRetryAt   DateTime?          @map("next_retry_at") @db.Timestamptz
  deliveredAt   DateTime?          @map("delivered_at") @db.Timestamptz
  response      Json?
  createdAt     DateTime           @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  workspace Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  endpoint  WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([endpointId])
  @@index([status, nextRetryAt])
  @@map("webhook_event")
}

enum WebhookEventStatus {
  pending
  delivered
  failed
  dead_letter

  @@map("webhook_event_status")
}

// ============================================================================
// API KEYS
// ============================================================================

model ApiKey {
  id          String            @id @default(uuid()) @db.Uuid
  workspaceId String            @map("workspace_id") @db.Uuid
  name        String            @db.VarChar(100)
  keyPrefix   String            @map("key_prefix") @db.VarChar(20)
  keyHash     String            @map("key_hash") @db.VarChar(255)
  role        ApiKeyRole        @default(member)
  environment ApiKeyEnvironment @default(test)
  lastUsedAt  DateTime?         @map("last_used_at") @db.Timestamptz
  expiresAt   DateTime?         @map("expires_at") @db.Timestamptz
  revokedAt   DateTime?         @map("revoked_at") @db.Timestamptz
  createdAt   DateTime          @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime          @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([keyPrefix])
  @@index([workspaceId])
  @@index([keyHash])
  @@map("api_key")
}

enum ApiKeyRole {
  owner
  admin
  member
  readonly

  @@map("api_key_role")
}

enum ApiKeyEnvironment {
  live
  test

  @@map("api_key_environment")
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id           String    @id @default(uuid()) @db.Uuid
  workspaceId  String    @map("workspace_id") @db.Uuid
  actorType    ActorType @map("actor_type")
  actorId      String    @map("actor_id") @db.VarChar(255)
  action       String    @db.VarChar(50)
  resourceType String    @map("resource_type") @db.VarChar(50)
  resourceId   String    @map("resource_id") @db.VarChar(255)
  changes      Json?
  metadata     Json      @default("{}")
  ipAddress    String?   @map("ip_address") @db.VarChar(45)
  userAgent    String?   @map("user_agent") @db.VarChar(500)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([workspaceId, resourceType, resourceId])
  @@index([workspaceId, createdAt])
  @@map("audit_log")
}

enum ActorType {
  api_key
  user
  system
  webhook

  @@map("actor_type")
}

// ============================================================================
// PROVIDER REFERENCE MAPPING
// ============================================================================

model ProviderRef {
  id         String     @id @default(uuid()) @db.Uuid
  workspaceId String    @map("workspace_id") @db.Uuid
  entityType EntityType @map("entity_type")
  entityId   String     @map("entity_id") @db.Uuid
  provider   Provider
  externalId String     @map("external_id") @db.VarChar(255)
  metadata   Json?
  createdAt  DateTime   @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, provider, entityType, externalId])
  @@unique([workspaceId, entityType, entityId, provider])
  @@index([workspaceId])
  @@index([entityType, entityId])
  @@map("provider_ref")
}

enum EntityType {
  customer
  offer
  offer_version
  subscription
  checkout
  product
  price
  coupon
  promotion_code

  @@map("entity_type")
}

// ============================================================================
// OUTBOX PATTERN FOR RELIABLE EVENT DELIVERY
// ============================================================================

model OutboxEvent {
  id            String            @id @default(uuid()) @db.Uuid
  workspaceId   String            @map("workspace_id") @db.Uuid
  eventType     String            @map("event_type") @db.VarChar(100)
  aggregateType String            @map("aggregate_type") @db.VarChar(50)
  aggregateId   String            @map("aggregate_id") @db.Uuid
  payload       Json
  status        OutboxEventStatus @default(pending)
  processedAt   DateTime?         @map("processed_at") @db.Timestamptz
  createdAt     DateTime          @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([status, createdAt])
  @@index([workspaceId])
  @@map("outbox_event")
}

enum OutboxEventStatus {
  pending
  processed
  failed

  @@map("outbox_event_status")
}

model DeadLetterEvent {
  id              String   @id @default(uuid()) @db.Uuid
  workspaceId     String   @map("workspace_id") @db.Uuid
  originalEventId String   @map("original_event_id") @db.Uuid
  endpointId      String   @map("endpoint_id") @db.Uuid
  eventType       String   @map("event_type") @db.VarChar(100)
  payload         Json
  failureReason   String   @map("failure_reason") @db.VarChar(1000)
  attempts        Int
  lastAttemptAt   DateTime @map("last_attempt_at") @db.Timestamptz
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz

  // Relations
  workspace Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  endpoint  WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([endpointId])
  @@map("dead_letter_event")
}

// ============================================================================
// IDEMPOTENCY
// ============================================================================

model IdempotencyKey {
  id            String   @id @default(uuid()) @db.Uuid
  key           String   @unique @db.VarChar(512)
  workspaceId   String   @map("workspace_id") @db.Uuid
  requestPath   String   @map("request_path") @db.VarChar(2048)
  requestMethod String   @map("request_method") @db.VarChar(10)
  response      Json?
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  expiresAt     DateTime @map("expires_at") @db.Timestamptz

  @@index([key])
  @@index([expiresAt])
  @@map("idempotency_key")
}

// ============================================================================
// PROCESSED PROVIDER EVENTS (for webhook deduplication)
// ============================================================================

model ProcessedProviderEvent {
  id              String   @id @default(uuid()) @db.Uuid
  provider        Provider
  providerEventId String   @map("provider_event_id") @db.VarChar(255)
  eventType       String   @map("event_type") @db.VarChar(100)
  processedAt     DateTime @default(now()) @map("processed_at") @db.Timestamptz

  @@unique([provider, providerEventId])
  @@index([processedAt])
  @@map("processed_provider_event")
}

// Legacy table alias - kept for backward compatibility during migration
// Will be removed after migration completes
model ProcessedStripeEvent {
  id            String   @id @default(uuid()) @db.Uuid
  stripeEventId String   @unique @map("stripe_event_id") @db.VarChar(255)
  eventType     String   @map("event_type") @db.VarChar(100)
  processedAt   DateTime @default(now()) @map("processed_at") @db.Timestamptz

  @@index([stripeEventId])
  @@index([processedAt])
  @@map("processed_stripe_event")
}

// ============================================================================
// FEEDBACK
// ============================================================================

model Feedback {
  id          String         @id @default(uuid()) @db.Uuid
  userId      String?        @map("user_id") @db.Uuid
  userEmail   String?        @map("user_email") @db.VarChar(255)
  type        FeedbackType
  title       String         @db.VarChar(200)
  description String         @db.Text
  status      FeedbackStatus @default(pending)
  response    String?        @db.Text
  respondedAt DateTime?      @map("responded_at") @db.Timestamptz
  createdAt   DateTime       @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime       @updatedAt @map("updated_at") @db.Timestamptz

  @@index([status])
  @@index([createdAt])
  @@map("feedback")
}

enum FeedbackType {
  bug
  feature
  contact
  other

  @@map("feedback_type")
}

enum FeedbackStatus {
  pending
  reviewed
  accepted
  rejected
  resolved

  @@map("feedback_status")
}

// ============================================================================
// USAGE METERING (Usage-Based Billing)
// ============================================================================

model UsageEvent {
  id             String   @id @default(uuid()) @db.Uuid
  workspaceId    String   @map("workspace_id") @db.Uuid
  customerId     String   @map("customer_id") @db.Uuid
  subscriptionId String?  @map("subscription_id") @db.Uuid
  metricKey      String   @map("metric_key") @db.VarChar(100)
  quantity       Decimal  @db.Decimal(20, 6)
  idempotencyKey String?  @unique @map("idempotency_key") @db.VarChar(255)
  timestamp      DateTime @default(now()) @db.Timestamptz
  properties     Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([workspaceId, customerId, metricKey])
  @@index([workspaceId, subscriptionId, metricKey])
  @@index([workspaceId, metricKey, timestamp])
  @@index([idempotencyKey])
  @@map("usage_event")
}

model UsageAggregate {
  id             String   @id @default(uuid()) @db.Uuid
  workspaceId    String   @map("workspace_id") @db.Uuid
  customerId     String   @map("customer_id") @db.Uuid
  subscriptionId String?  @map("subscription_id") @db.Uuid
  metricKey      String   @map("metric_key") @db.VarChar(100)
  periodStart    DateTime @map("period_start") @db.Timestamptz
  periodEnd      DateTime @map("period_end") @db.Timestamptz
  totalQuantity  Decimal  @map("total_quantity") @db.Decimal(20, 6)
  eventCount     Int      @default(0) @map("event_count")
  lastUpdatedAt  DateTime @default(now()) @map("last_updated_at") @db.Timestamptz

  @@unique([workspaceId, customerId, metricKey, periodStart])
  @@index([workspaceId, subscriptionId])
  @@map("usage_aggregate")
}

model UsageMetric {
  id           String               @id @default(uuid()) @db.Uuid
  workspaceId  String               @map("workspace_id") @db.Uuid
  key          String               @db.VarChar(100)
  name         String               @db.VarChar(200)
  description  String?              @db.VarChar(1000)
  unit         String?              @db.VarChar(50)
  aggregation  UsageAggregationType @default(sum)
  createdAt    DateTime             @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime             @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([workspaceId, key])
  @@index([workspaceId])
  @@map("usage_metric")
}

enum UsageAggregationType {
  sum
  max
  count
  last

  @@map("usage_aggregation_type")
}

// ============================================================================
// A/B EXPERIMENTS & PRICING EXPERIMENTS
// ============================================================================

model Experiment {
  id          String           @id @default(uuid()) @db.Uuid
  workspaceId String           @map("workspace_id") @db.Uuid
  key         String           @db.VarChar(100)
  name        String           @db.VarChar(200)
  description String?          @db.VarChar(1000)
  type        ExperimentType   @default(feature)
  status      ExperimentStatus @default(draft)

  // Traffic allocation (0-100)
  trafficAllocation Int @default(100) @map("traffic_allocation")

  // Targeting
  targetingRules Json @default("{}") @map("targeting_rules")

  // Scheduling
  startAt DateTime? @map("start_at") @db.Timestamptz
  endAt   DateTime? @map("end_at") @db.Timestamptz

  // Results
  winningVariantId String? @map("winning_variant_id") @db.Uuid
  concludedAt      DateTime? @map("concluded_at") @db.Timestamptz

  metadata  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  workspace      Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  variants       ExperimentVariant[]
  winningVariant ExperimentVariant?    @relation("WinningVariant", fields: [winningVariantId], references: [id])
  assignments    ExperimentAssignment[]

  @@unique([workspaceId, key])
  @@index([workspaceId])
  @@index([workspaceId, status])
  @@index([workspaceId, type, status])
  @@map("experiment")
}

enum ExperimentType {
  feature  // Feature flag experiment
  pricing  // Pricing experiment (different offers/prices)
  offer    // Different offer variants
  ui       // UI/UX experiments

  @@map("experiment_type")
}

enum ExperimentStatus {
  draft     // Not yet started
  running   // Currently active
  paused    // Temporarily stopped
  concluded // Finished with winner
  archived  // No longer relevant

  @@map("experiment_status")
}

model ExperimentVariant {
  id           String @id @default(uuid()) @db.Uuid
  experimentId String @map("experiment_id") @db.Uuid
  key          String @db.VarChar(100)
  name         String @db.VarChar(200)
  description  String? @db.VarChar(1000)

  // Weight for random assignment (relative to other variants)
  weight Int @default(1)

  // Variant configuration (depends on experiment type)
  // For feature: { enabled: true/false, config: {...} }
  // For pricing: { offerId: "...", priceOverride: 1999 }
  // For offer: { offerId: "..." }
  config Json @default("{}")

  // Control variant flag
  isControl Boolean @default(false) @map("is_control")

  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  experiment          Experiment             @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  winningForExperiment Experiment[]          @relation("WinningVariant")
  assignments         ExperimentAssignment[]

  @@unique([experimentId, key])
  @@index([experimentId])
  @@map("experiment_variant")
}

model ExperimentAssignment {
  id           String   @id @default(uuid()) @db.Uuid
  workspaceId  String   @map("workspace_id") @db.Uuid
  experimentId String   @map("experiment_id") @db.Uuid
  variantId    String   @map("variant_id") @db.Uuid
  customerId   String?  @map("customer_id") @db.Uuid
  sessionId    String?  @map("session_id") @db.VarChar(255)
  userId       String?  @map("user_id") @db.VarChar(255)

  // Assignment metadata
  assignedAt DateTime @default(now()) @map("assigned_at") @db.Timestamptz
  source     String   @default("auto") @db.VarChar(50) // auto, manual, override

  // Tracking
  firstExposureAt DateTime? @map("first_exposure_at") @db.Timestamptz
  lastExposureAt  DateTime? @map("last_exposure_at") @db.Timestamptz
  exposureCount   Int       @default(0) @map("exposure_count")

  // Conversion tracking
  convertedAt DateTime? @map("converted_at") @db.Timestamptz
  conversionValue Decimal? @map("conversion_value") @db.Decimal(20, 6)
  conversionMetadata Json? @map("conversion_metadata")

  metadata Json @default("{}")

  // Relations
  experiment Experiment        @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  variant    ExperimentVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([experimentId, customerId])
  @@unique([experimentId, sessionId])
  @@index([workspaceId])
  @@index([experimentId])
  @@index([variantId])
  @@index([customerId])
  @@index([workspaceId, experimentId, customerId])
  @@map("experiment_assignment")
}

// ============================================================================
// SEAT-BASED ENTITLEMENTS
// ============================================================================

model SeatAssignment {
  id          String    @id @default(uuid()) @db.Uuid
  workspaceId String    @map("workspace_id") @db.Uuid
  customerId  String    @map("customer_id") @db.Uuid
  featureKey  String    @map("feature_key") @db.VarChar(100)
  userId      String    @map("user_id") @db.VarChar(255)
  userEmail   String?   @map("user_email") @db.VarChar(255)
  userName    String?   @map("user_name") @db.VarChar(200)
  assignedAt  DateTime  @default(now()) @map("assigned_at") @db.Timestamptz
  expiresAt   DateTime? @map("expires_at") @db.Timestamptz
  metadata    Json      @default("{}")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  customer    Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, customerId, featureKey, userId])
  @@index([workspaceId, customerId, featureKey])
  @@index([workspaceId, userId])
  @@index([expiresAt])
  @@map("seat_assignment")
}
